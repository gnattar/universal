%
% SP 2010 Dec
%
% Session generation 38596, 107029
%
function dsp = sessgen2()
	global rootDataPath;
	rootDataPath = '/data/';
	doAnimal = {'38596', '107029'};
  doAnimal = {'117061'};
	doAnimal = {'38596'};
	doAnimal = {'107029'};
	doAnimal = {'94953', '38596','107028','107029','93098'};
	doAnimal = {'107028','93098'};
	doAnimal = {'38596','107029'};
	doAnimal = {'107029','94953'};
	doAnimal = {'94953', '38596','107029','107028'};
	doAnimal = {'107029'};
	doAnimal = {'94953'};
	dsp = {};

	% 117061
  if (sum(strcmp('117061',doAnimal)))
		dates = {'2010_12_04-1', '2010_12_06-1', '2010_12_11-1', '2010_12_16-1', '2010_12_17-1', ...
			'2011_01_14-1', '2011_01_19-1'};
		an = '117061';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = 'an117061_';
		roiPost = '';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost, roiPre, dsp);
	end

	% 93098
	if (sum(strcmp('93098',doAnimal)))
	  dates = { '2010_03_10-1', '2010_03_11-1', '2010_03_12-1', '2010_03_14-1', '2010_03_15-1', ...
							'2010_03_16-1', '2010_03_17-1', '2010_03_18-1', '2010_03_19-1', '2010_03_22-1', ...
							'2010_03_23-1', '2010_03_24-1', '2010_03_25-1', '2010_03_26-1', '2010_03_29-1', ...
							'2010_03_30-1', '2010_03_31-1', '2010_04_01-1', '2010_04_02-1', '2010_04_05-1', ...
							'2010_04_06-1', '2010_04_07-1', '2010_04_08-1', '2010_04_09-1'};
		an = '93098';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = 'an93098_';
		roiPost = '';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost, roiPre, dsp);
	end

	% 94953
  if (sum(strcmp('94953',doAnimal)))
	  dates = {'2010_03_31-1', '2010_04_08-1', '2010_04_01-1', '2010_04_02-1', '2010_04_09-1', ...
					'2010_04_05-1', '2010_04_12-1', '2010_04_06-1', '2010_04_20-2', '2010_04_23-2', ...
					'2010_04_20-1', '2010_04_23-1', '2010_04_16-1', '2010_04_21-1', '2010_04_26-1', ...
					'2010_04_15-1', '2010_04_13-1', '2010_04_16-2', '2010_04_21-2', '2010_04_27-1', ...
					'2010_04_15-2', '2010_04_14-1', '2010_04_19-1', '2010_04_22-1', '2010_04_30-1', ...
					'2010_04_07-1', '2010_04_14-2', '2010_04_19-2', '2010_04_22-2'};

	  dates = {'2010_04_27-1'};

		an = '94953';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = 'an94953_';
		roiPost = '';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost, roiPre, dsp);
	end

	% 38596
  if (sum(strcmp('38596',doAnimal)))
		dates = {'2010_02_02-1', '2010_02_03-1', '2010_02_04-1', '2010_02_08-1', '2010_02_09-1',  ...
			'2010_02_11-1', '2010_02_15-1', '2010_02_16-1', '2010_02_17-1', '2010_02_18-1', '2010_02_19-1', ...
			'2010_02_20-1', '2010_02_22-1', '2010_02_23-1', '2010_02_24-1', '2010_02_25-1', '2010_02_26-1',  ...
			'2010_03_01-1', '2010_03_02-1', '2010_03_03-1', '2010_02_05-1'}; 
		an = '38596';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = '';
		roiPost = '_cell_20100220_093_based';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost, roiPre,dsp);
	end

	% 107029
  if (sum(strcmp('107029',doAnimal)))
    dates = { '2010_08_02-1', '2010_08_03-1', '2010_08_04-1', '2010_08_05-1', '2010_08_06-1',  ...
			'2010_08_09-1', '2010_08_10-1', '2010_08_11-1', '2010_08_12-1', '2010_08_13-1', '2010_08_16-1', '2010_08_17-1',  ...
			'2010_08_18-1', '2010_08_19-1', '2010_08_20-1', '2010_08_21-1', '2010_08_22-1', '2010_08_25-1', '2010_08_26-1',  ...
			'2010_08_27-1'};
    dates = { '2010_08_19-1','2010_08_18-1','2010_08_17-1'};
		an = '107029';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = 'an107029_';
		roiPost = '';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost ,roiPre,dsp);
	end

	% 107028
  if (sum(strcmp('107028',doAnimal)))
    dates = { '2010_08_02-1', '2010_08_03-1', '2010_08_04-1', '2010_08_05-1', '2010_08_06-1',  ...
			'2010_08_09-1', '2010_08_10-1', '2010_08_11-1', '2010_08_12-1', '2010_08_13-1', '2010_08_16-1', '2010_08_17-1',  ...
			'2010_08_18-1', '2010_08_19-1', '2010_08_20-1', '2010_08_21-1', '2010_08_22-1', '2010_08_25-1', '2010_08_26-1',  ...
			'2010_08_27-1'};
		an = '107028';
		bseDir = [rootDataPath 'an' an filesep];
		wDir = [rootDataPath an 'w' filesep 'an' an filesep];
		roiPre = 'an107028_';
		roiPost = '';
		dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost ,roiPre,dsp);
	end


	% call runner
  runAnimals (dsp);


function dsp = buildDSPAnimal (an, dates, bseDir, wDir, roiPost, roiPre, dsp)
  for d=1:length(dates)
		wFullPath = [wDir dates{d}];
		flW = dir([wFullPath filesep '*wc']);
		if (length(flW) > 0)
		  roiPostS = roiPost;
			dashIdx = find(dates{d} == '-');
			dateStr = dates{d}(1:dashIdx(1)-1);
			if (str2num(dates{d}(dashIdx(1)+1)) == 2) ; dateStr = [dateStr 'b']; end
			bseFullPath = [bseDir dateStr];
			flBSE = dir(bseFullPath);
			if (length(flBSE) >= 5) ; % .. . behav ephus scanimage
        tdsp = buildsingleDSP(bseFullPath, bseDir, roiPre, roiPostS, dateStr, wFullPath, an);
	 		  dsp{length(dsp)+1} = tdsp;
			end
		end
	end

function dsp = buildsingleDSP(bseFullPath, bseDir, roiPre, roiPost, dateStr, wFullPath, an)
	% behvaior file - the one thing that is tricky
	bFileList = dir([bseFullPath filesep 'behav' filesep 'data_@pole_detect_spobj*mat']);
	for bfli=1:length(bFileList)
	  dateVal(bfli) = bFileList(bfli).datenum;
	end
	[irr behIdx] = max(dateVal);
	if (strcmp(an,'107029')) ; behIdx = length(bFileList) ; end
	if (strcmp(an,'38596')) ; behIdx = length(bFileList) ; end
	sessFile = [bseDir 'session2' filesep 'an' an '_' dateStr '_sess.mat'];

  dsp.baseFileName = sessFile;
	dsp.ephusFilePath = [bseFullPath filesep 'ephus'];
	dsp.behavSoloFilePath = [bseFullPath filesep 'behav' filesep bFileList(behIdx).name];

	dsp.scimFilePath = [bseFullPath filesep 'scanimage' filesep 'fluo_batch_out' filesep];
	dsp.roiArrayPath = [bseDir 'roi' filesep roiPre dateStr roiPost '.mat'];
	dsp.scimFileWC = 'Image_Registration_*main*tif';
%	dsp.scimFileWC = 'Image_Registration_4*tif';
%	dsp.scimFileWC = 'Image_Registration_5*main*tif';
	
	dsp.whiskerFilePath = [wFullPath filesep];
	dsp.whiskerFileWC = 'WDBP*.mat';
	dsp.defaultBarRadius = 21; % pixels for me
	useBadFrameTimesLastDate = datenum('2010_04_12', 'yyyy_mm_dd');
	dsp.useBadFrameTimes = 0;
	if (datenum(dateStr, 'yyyy_mm_dd') <= useBadFrameTimesLastDate) ; dsp.useBadFrameTimes = 1; end

	dsp.behavSoloParams{1} = {1, 1, 'Beam Breaks', [1 0 1], 1};
	dsp.behavSoloParams{2} = {2, 43, 'Water Valve', [0 0 1], 2};
	dsp.behavSoloParams{3} = {2, 44, 'Drinking Allowed Period', [0 0 0.5], 2};
	dsp.behavSoloParams{4} = {2, 49, 'Airpuff', [1 0.5 0], 2};
	dsp.behavSoloParams{5} = {3, [41 50], 'Pole Movement', [0 0 0], 2}; % ME

if ( 1 == 0) % DEBUG!!
	dsp.whiskerFileWC = 'WDBP*_001*.mat';
	dsp.scimFileWC = 'Image_Registration_4*main_01*tif';
end

% runner for a cell array of dataSourcePArams
function runAnimals (dsp)
  parfor d=1:length(dsp)
		disp('=======================================================================');
		disp('=======================================================================');
		disp('=======================================================================');
		disp(['PROCESSING ' dsp{d}.baseFileName ' ' datestr(now) '[' num2str(d) ']']);
		disp([' ']);
		disp(['USING BEHAVIOR FILE (check this !!): ' dsp{d}.behavSoloFilePath]);

		if ( 1 == 1 ) % normal mode
			try
				s = session.session.generateSession(dsp{d});

				psave(s);
			catch me
				disp(['*****************************************************************************']);
				disp(['*****************************************************************************']);
				disp(['ID: ' dsp{d}.baseFileName]);
				disp(['ERROR: ' me.message]);
				disp(['*****************************************************************************']);
				disp(['*****************************************************************************']);
			end
		else % let problems kill you -- good for debugs
			s = session.session.generateSession(dsp{d});
			psave(s);
		end
	end

function psave(s)
	s.saveToFile();
	disp(['*****************************************************************************']);
	disp(['*****************************************************************************']);
	disp(['SAVED: ' s.baseFileName]);
	disp(['*****************************************************************************']);
	disp(['*****************************************************************************']);
%  save(fn,'s');
